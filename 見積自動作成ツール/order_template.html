<? 
  var subtotalVal = Number(data.totalAmount) || 0; 
  var taxVal = Math.floor(subtotalVal * 0.1); 
  var totalVal = subtotalVal + taxVal; 
  var subtotal = subtotalVal.toLocaleString(); 
  var tax = taxVal.toLocaleString(); 
  var total = "￥" + totalVal.toLocaleString() + "-"; 
?>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>注文書</title>
  <style>
    @page { size: A4 portrait; margin: 0; }
    body { font-family: 'MS PMincho', 'Yu Mincho', 'Hiragino Mincho ProN', serif; padding: 25px 30px; color: #333; font-size: 10pt; }
    .page-header { text-align: center; margin-bottom: 15px; }
    .main-title { font-size: 24pt; font-weight: 700; border-bottom: 3px double #333; padding: 0 10px; }
    
    .flex-container { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    .flex-container td { vertical-align: top; }
    
    .customer-name { font-size: 16pt; font-weight: 700; border-bottom: 1px solid #333; min-width: 250px; display: inline-block; margin-bottom: 15px; }
    
    .condition-table { font-size: 9pt; width: 100%; }
    .condition-table td { padding: 2px 0; }
    .label { width: 80px; font-weight: bold; }
    
    .company-block { display: inline-block; text-align: left; vertical-align: top; }
    
    .stamp-table { border-collapse: collapse; text-align: center; font-size: 9pt; margin-bottom: 5px; width: 180px; }
    .stamp-table td { border: 1px solid #333; width: 60px; }
    .stamp-header td { height: 20px; background-color: #f0f0f0; }
    .stamp-body td { height: 60px; }

    .company-info { margin-top: 5px; font-size: 10pt; line-height: 1.3; }
    .company-name { font-size: 16pt; font-weight: 700; margin: 5px 0; }
    .license-info { font-size: 9pt; margin-bottom: 5px; }
    .logo-img { max-height: 50px; vertical-align: middle; margin-right: 10px; }
    
    .details-table { width: 100%; border-collapse: collapse; font-size: 9pt; }
    .details-table th, .details-table td { border: 1px solid #333; padding: 3px 5px; height: 18px; }
    .header-cell { background-color: #e5e7eb; font-weight: bold; text-align: center; }
    .row-summary { background-color: #f9fafb; font-weight: bold; }
    .border-none { border: none !important; background: none !important; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .page-break { page-break-before: always; }
  </style>
</head>
<body>
  <? for(var p = 0; p < data.pages.length; p++) { var items = data.pages[p]; ?>
  <? if (p > 0) { ?><div class="page-break"></div><? } ?>
  
  <? if (p === 0) { ?>
  <div class="page-header"><span class="main-title">注 文 書</span></div>
  
  <table class="flex-container">
    <tr>
      <td style="width: 55%;">
        <div class="customer-name"><?= data.header.vendor ?> 御中</div>
        <div style="margin-bottom:10px;">下記案件について発注いたします。</div>
        <table class="condition-table">
            <tr><td class="label">工事名</td><td>： <?= data.header.project || data.header.relEstId || "" ?></td></tr>
            <tr><td class="label">工事場所</td><td>： <?= data.header.location || "" ?></td></tr>
            <tr><td class="label">工期</td><td>： <?= data.header.period || "" ?></td></tr>
            <tr><td class="label">決済条件</td><td>： <?= data.header.payment || "" ?></td></tr>
            <tr><td class="label">有効期限</td><td>： <?= data.header.expiry || "" ?></td></tr>
        </table>
      </td>
      <td style="width: 45%; text-align: right;">
        <div class="company-block">
            <table class="stamp-table">
                <tr class="stamp-header"><td>検 印</td><td>検 印</td><td>作成者</td></tr>
                <tr class="stamp-body"><td></td><td></td><td></td></tr>
            </table>
            <div style="margin-bottom: 5px;">
                発注日: <?= data.header.date ?><br>
                No: <?= data.header.id ?>
            </div>
            <div class="company-info">
                <div class="license-info">愛知県知事許可（般-6）第64964号</div>
                <div style="display:flex; align-items:center;">
                    <img src="<?!= include("logo") ?>" class="logo-img" onerror="this.style.display='none'">
                    <div class="company-name">琉希工業株式会社</div>
                </div>
                <div>代表取締役　　足立　祐希</div>
                <div>〒444-0204</div>
                <div>岡崎市国正町字上川田44番地</div>
                <div>TEL (0564) 64-0721(代)</div>
                <div>FAX (0564) 64-0725</div>
            </div>
        </div>
      </td>
    </tr>
  </table>
  <? } ?>

  <table class="details-table">
    <thead><tr><th class="header-cell">品名</th><th class="header-cell">仕様</th><th class="header-cell">数量</th><th class="header-cell">単位</th><th class="header-cell">単価</th><th class="header-cell">金額</th></tr></thead>
    <tbody>
      <? items.forEach(item => { ?>
        <tr>
          <? if (!item.isPadding) { ?>
          <td><?= item.product ?></td><td><?= item.spec ?></td>
          <td class="text-right"><?= item.qty ?></td><td class="text-center"><?= item.unit ?></td>
          <td class="text-right"><?= Number(item.cost).toLocaleString() ?></td>
          <td class="text-right"><?= Number(item.amount).toLocaleString() ?></td>
          <? } else { ?>
          <td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td>
          <? } ?>
        </tr>
      <? }); ?>
      <? if (p === data.pages.length - 1) { ?>
        <tr class="row-summary">
          <td colspan="4" class="border-none"></td>
          <td class="text-center" style="border:1px solid #333;">小 計</td>
          <td class="text-right" style="border:1px solid #333; padding-right:5px;"><?= subtotal ?></td>
        </tr>
        <tr class="row-summary">
          <td colspan="4" class="border-none"></td>
          <td class="text-center" style="border:1px solid #333;">消費税</td>
          <td class="text-right" style="border:1px solid #333; padding-right:5px;"><?= tax ?></td>
        </tr>
        <tr class="row-summary">
          <td colspan="4" class="border-none"></td>
          <td class="text-center" style="border:1px solid #333;">合 計 <small>(税込)</small></td>
          <td class="text-right" style="border:1px solid #333; font-size:11pt; padding-right:5px;"><?= total ?></td>
        </tr>
      <? } ?>
    </tbody>
  </table>
  <? } ?>
</body>
</html>